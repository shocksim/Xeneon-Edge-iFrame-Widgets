<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Soccer Scoreboard</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --card-bg: #2a2a2a;
            --text-main: #ffffff;
            --text-sub: #b0b0b0;
            --accent: #38003c; /* Deep Purple */
            --highlight: #00ff85; /* Bright Green */
            --border: #444;
            --modal-bg: rgba(0, 0, 0, 0.85);
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-main);
            font-family: var(--font-family); overflow-x: hidden;
            display: flex; flex-direction: column; min-height: 100vh;
        }

        /* --- SCROLLBAR --- */
        html { scrollbar-width: thin; scrollbar-color: var(--card-bg) var(--bg-color); }
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background-color: var(--card-bg); border-radius: 10px; border: 2px solid var(--bg-color); }

        #widget-container { padding: 16px; max-width: 1200px; margin: 0 auto; width: 100%; box-sizing: border-box; flex-grow: 1; padding-bottom: 40px;}

        /* --- HEADER --- */
        header {
            display: flex; justify-content: space-between; align-items: flex-end;
            margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--border);
        }

        .header-left { display: flex; flex-direction: column; gap: 4px; }
        .header-right { display: flex; align-items: center; gap: 12px; padding-bottom: 4px;}

        h2 { margin: 0; font-size: 18px; text-transform: uppercase; letter-spacing: 1.2px; }

        .date-display {
            font-size: 13px; color: var(--text-sub); font-weight: 400; margin-top: 2px;
        }

        .live-indicator {
            font-size: 11px; color: var(--highlight); display: flex; align-items: center; gap: 6px; font-weight: 600;
        }
        
        .dot {
            height: 8px; width: 8px; background-color: var(--highlight); border-radius: 50%;
            display: inline-block; animation: pulse 2s infinite;
        }

        /* Attribution */
        .attribution-container {
            display: flex; align-items: center; color: var(--text-sub);
            font-weight: 400; font-size: 10px; opacity: 0.8;
        }

        .attribution-container a { margin-left: 4px; display: flex; }

        .attribution-logo {
            height: 12px; width: auto; vertical-align: middle;
            transition: opacity 0.2s; display: block;
        }
        .attribution-logo:hover { opacity: 1; }

        /* Settings Button */
        .settings-btn {
            background: none; border: none; cursor: pointer; color: var(--text-sub);
            padding: 8px; border-radius: 50%; transition: color 0.2s, background 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .settings-btn:hover { color: var(--text-main); background: rgba(255,255,255,0.1); }
        .settings-btn svg { width: 20px; height: 20px; display: block; }

        /* --- SCOREBOARD GRID --- */
        #scoreboard {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;
        }

        .game-card {
            background-color: var(--card-bg); border-radius: 12px; padding: 16px;
            display: flex; flex-direction: column; gap: 12px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3); position: relative;
            border: 1px solid transparent;
        }

        .favorite-highlight {
            border-color: var(--highlight);
            background: linear-gradient(145deg, var(--card-bg), #1a3a2a);
        }

        .league-badge {
            position: absolute; top: 10px; left: 12px;
            font-size: 10px; background: #444; padding: 2px 6px;
            border-radius: 4px; color: #ddd; font-weight: bold;
        }

        .game-status {
            font-size: 14px; color: var(--text-sub); text-align: right;
            font-weight: 600; min-height: 19px;
        }

        .team-row { display: flex; justify-content: space-between; align-items: center; }
        .team-info { display: flex; align-items: center; gap: 12px; }
        .team-logo { width: 32px; height: 32px; object-fit: contain; }
        .team-name { font-weight: 700; font-size: 16px; }
        .score { font-size: 20px; font-weight: 800; font-variant-numeric: tabular-nums; }
        .winner { color: var(--text-main); }
        .loser { color: var(--text-sub); }

        .message {
            text-align: center; padding: 30px; color: var(--text-sub);
            font-size: 16px; grid-column: 1 / -1;
        }

        /* --- SETTINGS MODAL --- */
        #settings-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-bg); z-index: 100;
            justify-content: center; align-items: center;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--bg-color); padding: 24px; border-radius: 12px;
            width: 340px; border: 1px solid #444;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            text-align: center;
            max-height: 85vh; overflow-y: auto;
        }

        .modal-title { margin-top: 0; font-size: 18px; margin-bottom: 20px; }
        
        .label-text {
            text-align: left; margin-bottom: 8px; font-size: 12px; color:#aaa; display: block; margin-top: 15px;
        }

        /* Checkbox Grid for Leagues */
        .league-toggles {
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px;
        }
        
        .league-option {
            display: flex; align-items: center; gap: 8px;
            background: #333; padding: 8px; border-radius: 6px;
            font-size: 12px; cursor: pointer;
        }
        
        .league-option input { cursor: pointer; }

        select {
            width: 100%; padding: 10px; margin-bottom: 5px;
            background: var(--card-bg); color: #fff; border: 1px solid #555;
            border-radius: 6px; font-size: 14px;
        }

        .modal-actions { display: flex; gap: 10px; justify-content: center; margin-top: 20px;}
        
        button.primary {
            background: var(--highlight); color: #000; border: none; padding: 8px 16px;
            border-radius: 6px; font-weight: 700; cursor: pointer;
        }
        button.secondary {
            background: transparent; color: var(--text-sub); border: 1px solid #555;
            padding: 8px 16px; border-radius: 6px; cursor: pointer;
        }
        button:hover { opacity: 0.9; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="widget-container">
    <header>
        <div class="header-left">
            <h2>Matchday Live</h2>
            <div id="current-date" class="date-display">Loading date...</div>
            <div class="live-indicator">
                <span class="dot"></span> LIVE DATA
            </div>
        </div>
        
        <div class="header-right">
            <div class="attribution-container">
                <span>Powered by</span>
                <a href="http://espn.go.com" target="_blank" title="Data provided by ESPN">
                    <img src="https://a.espncdn.com/redesign/assets/img/logos/espn-404@2x.png" class="attribution-logo" alt="ESPN">
                </a>
            </div>
            <button class="settings-btn" onclick="openSettings()" title="Settings">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
        </div>
    </header>

    <div id="scoreboard">
        <div class="message">Loading scores...</div>
    </div>
</div>

<div id="settings-modal">
    <div class="modal-content">
        <h3 class="modal-title">Widget Settings</h3>
        
        <label class="label-text">Active Leagues</label>
        <div class="league-toggles">
            <label class="league-option"><input type="checkbox" class="league-cb" value="eng.1"> Premier League</label>
            <label class="league-option"><input type="checkbox" class="league-cb" value="esp.1"> La Liga</label>
            <label class="league-option"><input type="checkbox" class="league-cb" value="ger.1"> Bundesliga</label>
            <label class="league-option"><input type="checkbox" class="league-cb" value="ita.1"> Serie A</label>
            <label class="league-option"><input type="checkbox" class="league-cb" value="fra.1"> Ligue 1</label>
            <label class="league-option"><input type="checkbox" class="league-cb" value="uefa.champions"> UCL</label>
            <label class="league-option"><input type="checkbox" class="league-cb" value="usa.1"> MLS</label>
            <label class="league-option"><input type="checkbox" class="league-cb" value="usa.nwsl"> NWSL</label>
        </div>

        <label for="teamSelect" class="label-text">Filter Team</label>
        <select id="teamSelect">
            <option value="all">Show All</option>
        </select>

        <label for="timezone-selector" class="label-text">Time Zone Display</label>
        <select id="timezone-selector">
            <option value="local">System Default (Your Time)</option>
            <optgroup label="US & Canada">
                <option value="America/New_York">Eastern Time (ET)</option>
                <option value="America/Chicago">Central Time (CT)</option>
                <option value="America/Denver">Mountain Time (MT)</option>
                <option value="America/Los_Angeles">Pacific Time (PT)</option>
                <option value="America/Anchorage">Alaska Time (AKT)</option>
                <option value="Pacific/Honolulu">Hawaii-Aleutian Time (HAT)</option>
            </optgroup>
            <optgroup label="Europe">
                <option value="Europe/London">London (GMT/BST)</option>
                <option value="Europe/Paris">Central European Time (CET)</option>
                <option value="Europe/Helsinki">Eastern European Time (EET)</option>
                <option value="Europe/Moscow">Moscow Standard Time (MSK)</option>
            </optgroup>
            <optgroup label="Asia & Pacific">
                <option value="Asia/Dubai">Gulf Standard Time (GST)</option>
                <option value="Asia/Kolkata">India Standard Time (IST)</option>
                <option value="Asia/Tokyo">Japan Standard Time (JST)</option>
                <option value="Australia/Sydney">Australian Eastern Time (AET)</option>
                <option value="Pacific/Auckland">New Zealand Time (NZT)</option>
            </optgroup>
            <optgroup label="Global">
                <option value="UTC">Coordinated Universal Time (UTC)</option>
            </optgroup>
        </select>

        <div class="modal-actions">
            <button class="secondary" onclick="closeSettings()">Cancel</button>
            <button class="primary" onclick="saveSettings()">Save</button>
        </div>
    </div>
</div>

<script>
    // Configuration for endpoints
    const BASE_URL = "https://site.api.espn.com/apis/site/v2/sports/soccer/";
    const REFRESH_RATE = 60000;
    
    // Config: Load from local storage
    let currentFavorite = localStorage.getItem('soccer_fav_team') || 'all';
    let selectedTimezone = localStorage.getItem('soccer_timezone') || "local";
    let activeLeagues = JSON.parse(localStorage.getItem('soccer_active_leagues')) || ['eng.1', 'esp.1', 'uefa.champions'];

    // State
    let allGamesCache = []; 
    
    // Map internal codes to display names for badges
    const LEAGUE_NAMES = {
        'eng.1': 'EPL',
        'esp.1': 'LIGA',
        'ger.1': 'BUND',
        'ita.1': 'SER A',
        'fra.1': 'LIG 1',
        'uefa.champions': 'UCL',
        'usa.1': 'MLS',
        'usa.nwsl': 'NWSL'
    };

    // --- Settings Logic ---
    function openSettings() {
        // Set Timezone
        document.getElementById('timezone-selector').value = selectedTimezone;
        
        // Set Checkboxes
        document.querySelectorAll('.league-cb').forEach(cb => {
            cb.checked = activeLeagues.includes(cb.value);
        });

        // Set Team Select (Needs to be populated first, handled by fetch)
        document.getElementById('teamSelect').value = currentFavorite;

        document.getElementById('settings-modal').style.display = 'flex';
    }

    function closeSettings() {
        document.getElementById('settings-modal').style.display = 'none';
    }

    function saveSettings() {
        // Save Timezone
        selectedTimezone = document.getElementById('timezone-selector').value;
        localStorage.setItem('soccer_timezone', selectedTimezone);

        // Save Leagues
        activeLeagues = Array.from(document.querySelectorAll('.league-cb:checked')).map(cb => cb.value);
        localStorage.setItem('soccer_active_leagues', JSON.stringify(activeLeagues));

        // Save Favorite Team
        currentFavorite = document.getElementById('teamSelect').value;
        localStorage.setItem('soccer_fav_team', currentFavorite);

        closeSettings();
        fetchScores(); // Refresh data with new league list
    }

    // --- Fetch Logic ---
    async function fetchScores() {
        const scoreboard = document.getElementById('scoreboard');
        
        if (activeLeagues.length === 0) {
            scoreboard.innerHTML = '<div class="message">Please select at least one league in Settings.</div>';
            return;
        }

        try {
            // Create an array of fetch promises
            const promises = activeLeagues.map(leagueCode => 
                fetch(`${BASE_URL}${leagueCode}/scoreboard`)
                    .then(res => res.json())
                    .then(data => ({ code: leagueCode, data: data }))
            );

            const results = await Promise.all(promises);
            
            // Combine all events into one array
            allGamesCache = [];
            
            results.forEach(result => {
                const leagueCode = result.code;
                if(result.data.events) {
                    // Tag each event with its league code for the badge
                    const taggedEvents = result.data.events.map(ev => ({...ev, leagueCode}));
                    allGamesCache = allGamesCache.concat(taggedEvents);
                }
            });

            // Sort games: Live/Pre/Post usually handled by date
            allGamesCache.sort((a, b) => new Date(a.date) - new Date(b.date));

            // If we have data, grab the date from the first event for the header
            if (allGamesCache.length > 0) {
                renderDate(allGamesCache[0]);
            } else {
                document.getElementById('current-date').innerText = "No games scheduled";
            }

            updateTeamDropdown(allGamesCache);
            renderGames(allGamesCache);

        } catch (error) {
            console.error("Error fetching scores:", error);
            scoreboard.innerHTML = '<div class="message">Unable to load scores. API may be rate limited.</div>';
        }
    }

    function renderDate(gameData) {
        // Parse the date from the first game
        let dateObj = new Date(gameData.date);
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').innerText = dateObj.toLocaleDateString('en-US', options);
    }

    function updateTeamDropdown(games) {
        const select = document.getElementById('teamSelect');
        // Preserve current selection logic in saveSettings, but rebuild list here
        const savedSelection = currentFavorite;
        
        let teams = [];
        games.forEach(game => {
            game.competitions[0].competitors.forEach(comp => {
                teams.push({
                    id: comp.team.id,
                    name: comp.team.displayName
                });
            });
        });

        // Remove duplicates and sort alpha
        teams = teams.filter((v,i,a)=>a.findIndex(t=>(t.id===v.id))===i);
        teams.sort((a,b) => a.name.localeCompare(b.name));

        select.innerHTML = '<option value="all">Show All</option>';
        teams.forEach(team => {
            const option = document.createElement('option');
            option.value = team.id;
            option.textContent = team.name;
            select.appendChild(option);
        });

        // Restore value if it exists in the new list
        if (teams.some(t => t.id === savedSelection)) {
            select.value = savedSelection;
        } else {
            select.value = 'all';
        }
    }

    function renderGames(games) {
        const scoreboard = document.getElementById('scoreboard');
        scoreboard.innerHTML = '';

        // Filter based on favorite selection
        const filteredGames = currentFavorite === 'all' 
            ? games 
            : games.filter(g => {
                const comps = g.competitions[0].competitors;
                return comps.some(c => c.team.id === currentFavorite);
            });

        if (filteredGames.length === 0) {
            scoreboard.innerHTML = '<div class="message">No matches found for current filters.</div>';
            return;
        }

        filteredGames.forEach(game => {
            const competition = game.competitions[0];
            const state = game.status.type.state; // 'pre', 'in', 'post'
            const isCompleted = game.status.type.completed;
            const leagueName = LEAGUE_NAMES[game.leagueCode] || 'SOC';

            const homeTeam = competition.competitors.find(c => c.homeAway === 'home');
            const awayTeam = competition.competitors.find(c => c.homeAway === 'away');

            const isFavGame = (homeTeam.team.id === currentFavorite || awayTeam.team.id === currentFavorite);

            // --- TIMEZONE & STATUS LOGIC ---
            let displayStatus;
            if (state === 'pre') {
                const gameDate = new Date(game.date);
                const timeOptions = { hour: 'numeric', minute: '2-digit' };
                if (selectedTimezone !== 'local') {
                    timeOptions.timeZone = selectedTimezone;
                }
                displayStatus = gameDate.toLocaleTimeString([], timeOptions);
            } else {
                displayStatus = game.status.type.shortDetail;
            }

            // --- SCORE LOGIC ---
            const awayScore = state === 'pre' ? '-' : awayTeam.score;
            const homeScore = state === 'pre' ? '-' : homeTeam.score;

            const card = document.createElement('div');
            card.className = `game-card ${isFavGame ? 'favorite-highlight' : ''}`;
            
            card.innerHTML = `
                <div class="league-badge">${leagueName}</div>
                <div class="game-status">${displayStatus}</div>
                
                <div class="team-row ${isCompleted && Number(homeTeam.score) < Number(awayTeam.score) ? 'loser' : 'winner'}">
                    <div class="team-info">
                        <img src="${homeTeam.team.logo}" class="team-logo" alt="${homeTeam.team.abbreviation}">
                        <span class="team-name">${homeTeam.team.abbreviation || homeTeam.team.shortDisplayName}</span>
                    </div>
                    <span class="score">${homeScore}</span>
                </div>

                <div class="team-row ${isCompleted && Number(awayTeam.score) < Number(homeTeam.score) ? 'loser' : 'winner'}">
                    <div class="team-info">
                        <img src="${awayTeam.team.logo}" class="team-logo" alt="${awayTeam.team.abbreviation}">
                        <span class="team-name">${awayTeam.team.abbreviation || awayTeam.team.shortDisplayName}</span>
                    </div>
                    <span class="score">${awayScore}</span>
                </div>
            `;

            scoreboard.appendChild(card);
        });
    }

    // Initial Load
    fetchScores();
    setInterval(fetchScores, REFRESH_RATE);
</script>

</body>
</html>
