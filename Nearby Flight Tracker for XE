<!DOCTYPE html><html>
<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <title>Radar Widget v3.1 (Robust)</title>
    
    <style>
        :root {
            --glass-bg: rgba(10, 15, 20, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent-radar: #00ff9d;
            --accent-error: #ff4444;
            --font-ui: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            margin: 0; background-color: #000; font-family: var(--font-ui);
            overflow: auto; 
            display: flex; justify-content: center; align-items: center; 
            min-height: 100vh;
            background-image: url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2672&auto=format&fit=crop');
            background-size: cover;
        }

        .radar-widget {
            position: relative; 
            width: min(900px, 95vw); 
            height: min(650px, 90vh);
            background: var(--glass-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 24px;
            box-shadow: 0 40px 80px rgba(0,0,0,0.6);
            display: flex; flex-direction: column; overflow: hidden;
        }

        .radar-header {
            min-height: 70px; padding: 0 25px; 
            display: flex; justify-content: space-between; align-items: center;
            z-index: 1000; border-bottom: 1px solid rgba(255,255,255,0.08);
            background: rgba(0,0,0,0.2);
        }

        .title {
            font-size: 0.9rem; font-weight: 700; color: var(--accent-radar);
            letter-spacing: 2px; text-transform: uppercase; display: flex; align-items: center; gap: 10px;
        }

        /* Dynamic Status Colors */
        .status-dot { width: 8px; height: 8px; background: var(--accent-radar); border-radius: 50%; box-shadow: 0 0 8px var(--accent-radar); animation: blink 2s infinite; }
        .status-dot.error { background: var(--accent-error); box-shadow: 0 0 8px var(--accent-error); }

        .location-input {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            padding: 6px 15px; border-radius: 20px; color: #ccc;
            font-family: inherit; font-size: 0.85rem; outline: none; width: 180px; transition: all 0.3s;
        }
        .location-input:focus { background: rgba(255,255,255,0.1); border-color: var(--accent-radar); width: 220px; color: white;}

        #map { flex-grow: 1; width: 100%; background: #111; z-index: 1; }

        .flight-stats {
            position: absolute; bottom: 25px; left: 25px; width: 280px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255,255,255,0.1);
            border-left: 3px solid var(--accent-radar);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            border-radius: 12px; padding: 20px; color: white; z-index: 1000;
        }
        
        .tracking-label { font-size: 0.65rem; color: var(--accent-radar); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px; font-weight: 700; opacity: 0.9;}
        .callsign-large { font-size: 2.2rem; font-weight: 800; line-height: 1; color: white; letter-spacing: -1px; }
        .airline-name { font-size: 1rem; color: #bbb; margin-bottom: 15px; font-weight: 400; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .stat-box { background: rgba(255,255,255,0.06); padding: 8px 10px; border-radius: 6px; }
        .stat-label { color: #666; text-transform: uppercase; font-size: 0.6rem; font-weight: 700; letter-spacing: 0.5px; }
        
        .stat-val { font-weight: 600; font-family: 'Consolas', monospace; font-size: 1rem; color: #fff; margin-top: 2px; }
        .unit-suffix { font-size: 0.7rem; color: #888; margin-left: 3px; font-weight: 400; }

        .route-info { 
            border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .route-point { display: flex; flex-direction: column; }
        .route-code { font-size: 1.4rem; font-weight: 700; color: white; line-height: 1.1;}
        .route-arrow { color: var(--accent-radar); font-size: 1.2rem; opacity: 0.6; }

        .api-warning { font-size: 0.6rem; color: #555; text-align: center; margin-top: 10px; font-style: italic;}

        /* Markers */
        .leaflet-marker-icon, .plane-icon { transition: transform 1s linear, top 1s linear, left 1s linear; }
        .plane-svg { transition: transform 0.5s ease; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.8)); }
        .plane-icon.closest-target path { fill: var(--accent-radar) !important; filter: drop-shadow(0 0 10px var(--accent-radar)); }
        
        .radar-pulse { border: 1px solid var(--accent-radar); border-radius: 50%; animation: expand 4s infinite; box-sizing: border-box; }
        @keyframes expand { 0% { transform: scale(0.1); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

    </style>
</head>
<body>

    <div class="radar-widget">
        <div class="radar-header">
            <div class="title" id="statusTitle">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">LIVE TRAFFIC</span>
            </div>
            <input type="text" class="location-input" id="searchBox" placeholder="Search City..." onkeydown="handleSearch(event)">
        </div>
        
        <div id="map"></div>

        <div class="flight-stats" id="flightPanel">
            <div class="tracking-label">Tracking Nearest Flight</div>
            <div class="callsign-large" id="f-callsign">SCANNING</div>
            <div class="airline-name" id="f-airline">Initializing Radar...</div>
            
            <div class="stat-grid">
                <div class="stat-box">
                    <div class="stat-label">Altitude</div>
                    <div class="stat-val" id="f-alt">---</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Speed</div>
                    <div class="stat-val" id="f-speed">---</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Distance</div>
                    <div class="stat-val" id="f-dist">---</div>
                </div>
                 <div class="stat-box">
                    <div class="stat-label">Type</div>
                    <div class="stat-val" id="f-country">---</div>
                </div>
            </div>

            <div class="route-info">
                <div class="route-point">
                    <div class="stat-label">ORIGIN</div>
                    <div class="route-code" id="route-origin">---</div>
                </div>
                <div class="route-arrow">âœˆ</div>
                <div class="route-point" style="text-align: right;">
                    <div class="stat-label">DESTINATION</div>
                    <div class="route-code" id="route-dest">---</div>
                </div>
            </div>
            <div class="api-warning" id="api-status">Route data requires API Key</div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- CONFIGURATION ---
        const FLIGHTAWARE_API_KEY = ""; 
        // ---------------------

        const OPENSKY_API = "https://opensky-network.org/api/states/all";
        
        const AIRLINE_MAP = {
            "AAL": "American Airlines", "UAL": "United Airlines", "DAL": "Delta Air Lines", "SWA": "Southwest",
            "BAW": "British Airways", "DLH": "Lufthansa", "AFR": "Air France", "KLM": "KLM",
            "QFA": "Qantas", "UAE": "Emirates", "ETD": "Etihad", "QTR": "Qatar Airways",
            "JAL": "Japan Airlines", "ANA": "All Nippon", "CPA": "Cathay Pacific", "SIA": "Singapore Airlines",
            "VIR": "Virgin Atlantic", "VOZ": "Virgin Australia", "ASA": "Alaska Airlines", "JBU": "JetBlue",
            "NKS": "Spirit Wings", "FFT": "Frontier", "WJA": "WestJet", "ACA": "Air Canada",
            "AMX": "Aeromexico", "IBE": "Iberia", "AZA": "Alitalia", "SAS": "SAS",
            "FIN": "Finnair", "EZY": "EasyJet", "RYR": "Ryanair", "THY": "Turkish Airlines",
            "AIC": "Air India", "CSN": "China Southern", "CCA": "Air China", "CES": "China Eastern",
            "KOREAN": "Korean Air", "KAL": "Korean Air", "EVA": "EVA Air", "CAL": "China Airlines",
            "UPS": "UPS Airlines", "FDX": "FedEx", "GTI": "Atlas Air"
        };

        let map, planesLayer, radarCircle;
        let currentLat = 37.7749, currentLng = -122.4194; // Default: SF
        let currentlyLockedCallsign = null; 
        let planeRegistry = {}; 

        function initMap() {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([currentLat, currentLng], 10);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { 
                maxZoom: 19, subdomains: 'abcd', opacity: 0.9 
            }).addTo(map);
            
            planesLayer = L.layerGroup().addTo(map);
            updateHomeMarker();
            fetchPlanes(); 
            setInterval(fetchPlanes, 10000); 
        }

        function updateHomeMarker() {
            if (radarCircle) map.removeLayer(radarCircle);
            radarCircle = L.marker([currentLat, currentLng], { 
                icon: L.divIcon({ className: 'radar-pulse', iconSize: [100, 100], iconAnchor: [50, 50] }) 
            }).addTo(map);
        }

        function setStatus(isError, text) {
            const dot = document.getElementById('statusDot');
            const txt = document.getElementById('statusText');
            
            if(isError) {
                dot.classList.add('error');
                txt.style.color = '#ff4444';
                txt.innerText = text;
            } else {
                dot.classList.remove('error');
                txt.style.color = '#00ff9d';
                txt.innerText = text;
            }
        }

        async function fetchPlanes() {
            // WIDENED SEARCH BOX (0.5 -> 0.8) to ensure we find planes
            const box = 0.8; 
            
            try {
                const response = await fetch(`${OPENSKY_API}?lamin=${currentLat-box}&lomin=${currentLng-box}&lamax=${currentLat+box}&lomax=${currentLng+box}`);
                
                if (!response.ok) {
                    throw new Error("API Rate Limit");
                }

                const data = await response.json();
                setStatus(false, "LIVE TRAFFIC");

                const activeIcaos = new Set();
                let closest = null, minDst = Infinity;

                // OpenSky returns null 'states' if no planes are found
                if (data && data.states) {
                    data.states.forEach(s => {
                        const [icao, callsignRaw, country, , , lon, lat, alt, onG, vel, head] = s;
                        const callsign = callsignRaw.trim();
                        
                        if (lat && lon && !onG) {
                            const pLoc = L.latLng(lat, lon);
                            const dst = map.distance(L.latLng(currentLat, currentLng), pLoc);
                            
                            const planeData = { icao, callsign, country, alt, vel, head, lat, lon, dst };
                            
                            if (dst < minDst) { minDst = dst; closest = planeData; }
                            
                            updateOrAddPlane(planeData);
                            activeIcaos.add(icao);
                        }
                    });
                } else {
                    // Valid response but empty sky
                    document.getElementById('f-callsign').innerText = "NO TRAFFIC";
                    document.getElementById('f-airline').innerText = "Sky is clear nearby";
                }

                // Clean up old planes only if API call was successful
                Object.keys(planeRegistry).forEach(icao => {
                    if (!activeIcaos.has(icao)) {
                        planesLayer.removeLayer(planeRegistry[icao]);
                        delete planeRegistry[icao];
                    }
                });

                if (closest) {
                    updateStatsPanel(closest);
                    highlightClosest(closest.icao);
                }

            } catch (e) { 
                console.error(e);
                setStatus(true, "API LIMIT / RETRYING");
                // Do not delete planes if API fails, just keep them frozen until next success
            }
        }

        function updateOrAddPlane(p) {
            const html = `
                <svg class="plane-svg" viewBox="0 0 24 24" fill="#fff" style="transform: rotate(${p.head-45}deg); width: 100%; height: 100%;">
                    <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                </svg>`;

            if (planeRegistry[p.icao]) {
                const marker = planeRegistry[p.icao];
                marker.setLatLng([p.lat, p.lon]);
                const iconEl = marker.getElement();
                if(iconEl) {
                    const svg = iconEl.querySelector('svg');
                    if(svg) svg.style.transform = `rotate(${p.head-45}deg)`;
                }
            } else {
                const icon = L.divIcon({ className: 'plane-icon', html: html, iconSize: [30,30], iconAnchor: [15,15] });
                const marker = L.marker([p.lat, p.lon], { icon: icon }).addTo(planesLayer);
                planeRegistry[p.icao] = marker;
            }
        }

        function highlightClosest(targetIcao) {
            Object.keys(planeRegistry).forEach(icao => {
                const marker = planeRegistry[icao];
                const iconEl = marker.getElement();
                if (!iconEl) return;

                if (icao === targetIcao) {
                    marker.setZIndexOffset(1000);
                    iconEl.classList.add('closest-target');
                    iconEl.querySelector('path').style.fill = '#00ff9d';
                } else {
                    marker.setZIndexOffset(0);
                    iconEl.classList.remove('closest-target');
                    iconEl.querySelector('path').style.fill = '#ffffff';
                }
            });
        }

        function updateStatsPanel(data) {
            const alt = Math.round(data.alt || 0).toLocaleString();
            const spd = Math.round((data.vel || 0) * 3.6);
            const dst = (data.dst / 1000).toFixed(1);

            document.getElementById('f-callsign').innerText = data.callsign || "N/A";
            document.getElementById('f-alt').innerHTML = `${alt}<span class="unit-suffix">m</span>`;
            document.getElementById('f-speed').innerHTML = `${spd}<span class="unit-suffix">km/h</span>`;
            document.getElementById('f-dist').innerHTML = `${dst}<span class="unit-suffix">km</span>`;
            document.getElementById('f-country').innerText = "CIVIL"; 

            const prefix = data.callsign.substring(0, 3).toUpperCase();
            let airlineName = AIRLINE_MAP[prefix];
            if (!airlineName) {
                if (/\d/.test(prefix)) airlineName = "Private / GA";
                else airlineName = `Unknown (${prefix})`;
            }
            document.getElementById('f-airline').innerText = airlineName;

            if (data.callsign !== currentlyLockedCallsign) {
                currentlyLockedCallsign = data.callsign;
                fetchRouteData(data.callsign);
            }
        }

        async function fetchRouteData(callsign) {
            const originEl = document.getElementById('route-origin');
            const destEl = document.getElementById('route-dest');
            const statusEl = document.getElementById('api-status');

            originEl.innerText = "---"; destEl.innerText = "---";

            if (!FLIGHTAWARE_API_KEY) {
                statusEl.innerText = "Add FlightAware Key to see Route";
                statusEl.style.color = "#888";
                return;
            }

            statusEl.innerText = "Fetching Route...";
            
            try {
                const res = await fetch(`https://aeroapi.flightaware.com/aeroapi/flights/${callsign}?max_pages=1`, {
                    headers: { "x-apikey": FLIGHTAWARE_API_KEY }
                });
                
                if (!res.ok) throw new Error("API Auth Failed");
                
                const json = await res.json();
                if (json.flights && json.flights.length > 0) {
                    const f = json.flights[0];
                    originEl.innerText = f.origin ? f.origin.code_icao : "N/A";
                    destEl.innerText = f.destination ? f.destination.code_icao : "N/A";
                    statusEl.innerText = "Route Data Active";
                    statusEl.style.color = "#00ff9d";
                }
            } catch (e) {
                statusEl.innerText = "Route Not Found";
                statusEl.style.color = "#ff5555";
            }
        }

        async function handleSearch(e) {
            if (e.key === 'Enter') {
                const val = document.getElementById('searchBox').value;
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val}`);
                const d = await res.json();
                if (d[0]) {
                    currentLat = parseFloat(d[0].lat);
                    currentLng = parseFloat(d[0].lon);
                    map.setView([currentLat, currentLng], 10);
                    updateHomeMarker();
                    fetchPlanes();
                }
            }
        }

        initMap();
    </script>
</body>
</html>
